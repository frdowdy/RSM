---
title: "RSM_code"
output:
  html_document: default
  html_notebook: default
---

First we're going to set up R to to our target directory and clear the workspace.
```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  # Set the figure options
                      fig.align = "center",
                      dev='png')

```

Clear RStudio
```{r clear}
  # cat(rep("\n",50)) # Clear Console
  rm(list=ls(all=TRUE)) # clear workspace
  graphics.off() # closes all graphics
```

Install function for needed packages
```{r packages function, message = FALSE, warning=FALSE}
   
  packages<-function(x){
    x<-as.character(match.call()[[2]])
    if (!require(x,character.only=TRUE)){
      install.packages(pkgs=x,repos="http://cran.r-project.org")
      require(x,character.only=TRUE)
    }
  }
  packages(rsm)
```


```{r get data, message = FALSE, warning=FALSE}
# https://cran.r-project.org/web/packages/rsm/vignettes/rsm.pdf
packages(XLConnect)
data <- readWorksheetFromFile("preliminary_RSM.xlsx",sheet=1)

# Withhold validation points from dataet
data_training <- data[1:13,]
```

Let's try it with our previous data set:
```{r generate RSM model for cycle 4}
rsm4 <- rsm(voltage_cycle_4 ~ SO(temp, acetate), data = data_training)
summary(rsm4)
```
Let's try visualizing these results.
```{r voltage_cycle_4}
persp(rsm4, ~ temp + acetate, col = rainbow(50), contours = "colors")
contour(rsm4, ~ temp + acetate, col = rainbow(50), contours = "colors")


packages(ggplot2)
packages(ggthemes)
packages(cowplot)
plot_acetate <- ggplot(data_training, aes(acetate, voltage_cycle_4)) + geom_point() + theme_few()
plot_temp <- ggplot(data_training, aes(temp, voltage_cycle_4)) + geom_point() + theme_few() 
plot_grid(plot_acetate, plot_temp, align='h', labels=c('a', 'b'))
```
Note that we could also plot this with other packages using plot.it=false
Now let's try this with our most recent data set.
```{r voltage_cycle_5}
rsm5 <- rsm(voltage_cycle_5 ~ SO(temp, acetate), data = data_training)
summary(rsm5)
persp(rsm5, ~ temp + acetate, col = rainbow(50), contours = "colors")
contour(rsm5, ~ temp + acetate, col = rainbow(50), contours = "colors")

#Look at slices against each factor
plot_acetate <- ggplot(data_training, aes(acetate, voltage_cycle_5)) + geom_point() + theme_few()
plot_temp <- ggplot(data_training, aes(temp, voltage_cycle_5)) + geom_point() + theme_few() 
plot_grid(plot_acetate, plot_temp, align='h', labels=c('a', 'b'))

```
Is there a better point in time to analyze this data? Let's run this against multiple time points and find which creates the best model.
```{r apply to multiple time points}
all_p_values <- as.data.frame(matrix(NA,ncol(data_training)-4,7))

packages(broom) 


# Start loop
for(i in 5:ncol(data_training)){
model <- rsm(data_training[,i] ~ SO(temp, acetate), data = data_training)
all_p_values[i-4,] <- c(colnames(data_training)[i],tidy(model)$p.value) # get coefficient table as a data frame https://stackoverflow.com/questions/31570440/extract-regression-p-value-in-r
}
#End Loop

# Append column names
colnames(all_p_values) <- c("Time",tidy(model)$term)
all_p_values

# Plot

```
Now let's load in all the cycle 5 data so far.
